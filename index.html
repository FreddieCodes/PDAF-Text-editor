<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="./styles/style.css">
  <link rel="stylesheet" href="./styles/prism.css"/>
  <title>Text Editor</title>
</head>
<body>
  <div id="buttonarea">
    <button id ="load-button"> Load </button>
    <button id ="save-as-button"> Save As </button>
    <button id ="save-button"> Save</button>
    <button id ="syntax-button">Syntax</button>
    <button id ="word-count">Count</button>
    <button id ="save-position">Save Position</button>
    <button id ="restore-position">Restor Position</button>
  </div>

  <section class="container">
    <div class="left-half">
      <button id="tree-dir">Tree Directory</button>
      <li id="tree">
      </li>
    </div>
    <div class="right-half">
      <pre class="line-numbers"><code class="language-javascript" id="editor" contentEditable=true>function ()</code></pre>
    </div>
  </section>

  <!-- <iframe>
  <html>
  <body id="editor" contentEditable = "true"></body>
  </html>
</iframe> -->

<script type="text/javascript" src="./readFile.js"></script>
<script src="prism.js"></script>
<!-- Updating Syntax -->
<script>
const path = require("path");
// keypress event hashed out until cursor issues can be resolved.
document.addEventListener("keypress", updateSyntax);
var syntaxBtn = document.getElementById("syntax-button");
var editor = document.getElementById("editor");
// position buttons
var savePositionBtn = document.getElementById("save-position")
var restorePositionBtn = document.getElementById("restore-position")

savePositionBtn.addEventListener("click", saveRangePosition);
restorePositionBtn.addEventListener("click", restoreRangePosition);


syntaxBtn.addEventListener("click", updateSyntax);

function updateSyntax() {

  // saveCaretPosition(editor)
  saveRangePosition()
  // syntaxRecog()
  // targets only the editor element
  Prism.highlightElement(editor);
  restoreRangePosition()
  // restoreRangePosition()
  // targets the whole page
  // Prism.highlightAll();
}

const treeBtn = document.getElementById("tree-dir");
const li = document.getElementById("tree");

treeBtn.addEventListener("click", treeDir);

function treeDir() {
  const folder = "./";

  fs.readdir(folder, (err, files) => {
    files.forEach(file => {
      console.log(file);
      tree += `<li> ${file} </li>`;
    });
    li.innerHTML = tree;
  });
}

function syntaxRecog(){
    var fileLang = currentFileName.replace(/.*\./, "")
    
    var languages = { "css": "css",
                      "js": "javascript",
                      "rb": "ruby",
                      "html": "html",
                      "md": "markdown"
                    }
    
    // console.log(languages[fileLang.toString()])
    editor.className = `language-${languages[fileLang.toString()]}`
}

function saveCaretPosition(editor){
    var selection = window.getSelection();
    var range = selection.getRangeAt(0);
    range.setStart( editor, 0 );
    var len = range.toString().length;

    return function restore(){
        var pos = getTextNodeAtPosition(editor, len);
        selection.removeAllRanges();
        var range = new Range();
        range.setStart(pos.node ,pos.position);
        selection.addRange(range);

    }
}

// function saveCaretPosition(editor){
//     var selection = window.getSelection();
//     var range = selection.getRangeAt(0);
//     range.setStart( editor, 0 );
//     var len = range.toString().length;
// }

// function restore(){
//         var pos = getTextNodeAtPosition(editor, len);
//         selection.removeAllRanges();
//         var range = new Range();
//         range.setStart(pos.node ,pos.position);
//         selection.addRange(range);
// }

function saveRangePosition()
  {
  var range=window.getSelection().getRangeAt(0);
  var sC=range.startContainer,eC=range.endContainer;

  A=[];while(sC!==editor){A.push(getNodeIndex(sC));sC=sC.parentNode}
  B=[];while(eC!==editor){B.push(getNodeIndex(eC));eC=eC.parentNode}
  

  window.rp={"sC":A,"sO":range.startOffset,"eC":B,"eO":range.endOffset};
  // console.log(window.rp)
  }

  function getNodeIndex(n){var i=0;while(n=n.previousSibling)i++;return i}

  function restoreRangePosition(){
  editor.focus()
  var selection=window.getSelection(),range=selection.getRangeAt(0);
  var x,C,sC=editor,eC=editor;

  C=rp.sC;x=C.length;while(x--)sC=sC.childNodes[C[x]];
  C=rp.eC;x=C.length;while(x--)eC=eC.childNodes[C[x]];
  
// console.log(rp.s0)find out what sC bug is
  range.setStart(sC,rp.sO);
  range.setEnd(eC,rp.eO);
  selection.removeAllRanges();
  selection.addRange(range)
  }

</script>
</body>
</html>
